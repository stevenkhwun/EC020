---
title: 'Instrumental Variables Estimation and Two Stage Least Squares'
date: "2023/7/4"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


> Learning points:
>
> * conducting IV estimation by `ivreg()` function of `AER` package

The natural logarithm of 10 is `r format(log(10), digit=4)`.

We first load the required packages and datasets.

```{r message=FALSE, warning=FALSE}
# load the required library
library(AER); library(stargazer); library(wooldridge)
# load the required dataset
data(list=c("card", "mroz", "wage2"), wooldridge)
```


# Instrumental variables in simple regression models

```{r message=FALSE, warning=FALSE}
# restrict to non-missing wage observations
oursample <- subset(mroz, !is.na(wage))

# OLS slope parameter manually
with(oursample, cov(log(wage),educ) / var(educ))

# IV slope parameter manually
with(oursample, cov(log(wage),fatheduc) / cov(educ,fatheduc))

# OLS automatically
reg.ols <- lm(log(wage) ~ educ, data=oursample)

# IV automatically
reg.iv <- ivreg(log(wage) ~ educ | fatheduc, data=oursample)

# pretty regression table
stargazer(reg.ols, reg.iv, type="text")

```





```{r}
# Example 15.2 on p. 502

# IV automatically
reg.iv2 <- ivreg(log(wage) ~ educ | sibs, data=wage2)
stargazer(reg.iv2, type="text")
```

```{r}
# Complete Example 15.2

# variable educ and sibs are correlated
reg <- lm(educ ~ sibs, data = wage2)
stargazer(reg, type = "text")

# run the ols and iv estimation
olsreg <- lm(log(wage) ~ educ, data = wage2)
ivreg1 <- ivreg(log(wage) ~ educ | sibs, data = wage2)

# compare the result
stargazer(olsreg, ivreg1, type = "text")
```


# More exogenous regressors (Example 15.4 of Wooldridge)

We use `card` data to estimate the return to education. Education is allowed to be endogenous and instrumented with the dummy variable `near4` which indicates whether the individual grew up close to a college.

We first check for relevance by regressing the endogenous independent variable `educ` on all exogenous variables including the instrument `near4`.

```{r}
# reduced form equation: check for relevance
redf <- lm(educ ~ nearc4 + exper + I(exper^2) + black + smsa + south + smsa66 +
            reg662 + reg663 + reg664 + reg665 + reg666 + reg667 + reg668 + reg669,
          data = card)
stargazer(redf, keep=c("nearc4"), type="text", title = "Reduced form equation")
```

The parameter for `nearc4` is highly significantly different from zero, so relevance is supported. We then estimate the log wage equation with OLS and IV.

```{r}
# OLS
ols <- lm(log(wage) ~ educ + exper + I(exper^2) + black + smsa + south + smsa66 +
          reg662 + reg663 + reg664 + reg665 + reg666 + reg667 + reg668 + reg669,
          data = card)

# IV
iv <- ivreg(log(wage) ~ educ + exper + I(exper^2) + black + smsa + south + smsa66 +
            reg662 + reg663 + reg664 + reg665 + reg666 + reg667 + reg668 + reg669 |
            nearc4 + exper + I(exper^2) + black + smsa + south + smsa66 +
            reg662 + reg663 + reg664 + reg665 + reg666 + reg667 + reg668 +
            reg669, data = card)

# table of the results
stargazer(ols, iv, keep=c("ed", "exp", "bl"), type="text", title = "OLS vs IV estimation")
```

> Notes on R
>
> In `ivreg()`, we have to include the exogenous variables both to the list of regressors left of the `|` symbol and to the list of exogenous instrument to the right of the `|` symbol.




